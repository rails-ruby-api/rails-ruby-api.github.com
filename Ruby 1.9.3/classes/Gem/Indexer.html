<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Gem::Indexer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../css/github.css" type="text/css" media="screen" />
<script src="../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Class</span> 
            Gem::Indexer 
            
                <span class="parent">&lt; 
                    
                    <a href="../Object.html">Object</a>
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../files/lib/rubygems/indexer_rb.html">lib/rubygems/indexer.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>Top level class for building the gem repository index.</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-abbreviate">abbreviate</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>B</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-build_indicies">build_indicies</a>,
              </li>
            
              
              <li>
                <a href="#method-i-build_legacy_indicies">build_legacy_indicies</a>,
              </li>
            
              
              <li>
                <a href="#method-i-build_marshal_gemspecs">build_marshal_gemspecs</a>,
              </li>
            
              
              <li>
                <a href="#method-i-build_modern_index">build_modern_index</a>,
              </li>
            
              
              <li>
                <a href="#method-i-build_modern_indicies">build_modern_indicies</a>,
              </li>
            
              
              <li>
                <a href="#method-i-build_rss">build_rss</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-collect_specs">collect_specs</a>,
              </li>
            
              
              <li>
                <a href="#method-i-compact_specs">compact_specs</a>,
              </li>
            
              
              <li>
                <a href="#method-i-compress">compress</a>,
              </li>
            
              
              <li>
                <a href="#method-i-compress_indicies">compress_indicies</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>G</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-gem_file_list">gem_file_list</a>,
              </li>
            
              
              <li>
                <a href="#method-i-generate_index">generate_index</a>,
              </li>
            
              
              <li>
                <a href="#method-i-gzip">gzip</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-install_indicies">install_indicies</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>M</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-make_temp_directories">make_temp_directories</a>,
              </li>
            
              
              <li>
                <a href="#method-i-map_gems_to_specs">map_gems_to_specs</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>N</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-c-new">new</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-paranoid">paranoid</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-sanitize">sanitize</a>,
              </li>
            
              
              <li>
                <a href="#method-i-sanitize_string">sanitize_string</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>U</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-update_index">update_index</a>,
              </li>
            
              
              <li>
                <a href="#method-i-update_specs_index">update_specs_index</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  
    <!-- Includes -->
    <div class="sectiontitle">Included Modules</div>
    <ul>
      
        <li>
          
            <a href="UserInteraction.html">
              Gem::UserInteraction
            </a>
          
        </li>
      
    </ul>
  



  

    

    

    


    
      <!-- Section attributes -->
      <div class="sectiontitle">Attributes</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>build_legacy</td>
            <td class='attr-desc'><p>Build indexes for RubyGems older than 1.2.0 when true</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [RW]
            </td>
            <td class='attr-name'>build_modern</td>
            <td class='attr-desc'><p>Build indexes for RubyGems 1.2.0 and newer when true</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>dest_directory</td>
            <td class='attr-desc'><p>Index install location</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>dest_latest_specs_index</td>
            <td class='attr-desc'><p>Latest specs index install location</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>dest_prerelease_specs_index</td>
            <td class='attr-desc'><p>Prerelease specs index install location</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>dest_specs_index</td>
            <td class='attr-desc'><p>Specs index install location</p></td>
          </tr>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>directory</td>
            <td class='attr-desc'><p>Index build directory</p></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
    
      <div class="sectiontitle">Class Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-c-new">
            
              <a name="method-c-new"></a><b>new</b>(directory, options = {})
            
          </div>
          
          
            <div class="description">
              <p>Create an indexer that will index the gems in <code>directory</code>.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-c-new_source')" id="l_method-c-new_source">show</a>
                
              </p>
              <div id="method-c-new_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 56</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">initialize</span>(<span class="ruby-identifier">directory</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">require</span> <span class="ruby-string">'fileutils'</span>
  <span class="ruby-identifier">require</span> <span class="ruby-string">'tmpdir'</span>
  <span class="ruby-identifier">require</span> <span class="ruby-string">'zlib'</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-keyword">defined?</span>(<span class="ruby-constant">Builder</span><span class="ruby-operator">::</span><span class="ruby-constant">XChar</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Gem::Indexer requires that the XML Builder library be installed:&quot;</span>             <span class="ruby-string">&quot;\n\tgem install builder&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">options</span> = { <span class="ruby-value">:build_legacy</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-value">:build_modern</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> }.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">options</span>

  <span class="ruby-ivar">@build_legacy</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:build_legacy</span>]
  <span class="ruby-ivar">@build_modern</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:build_modern</span>]

  <span class="ruby-ivar">@rss_title</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:rss_title</span>]
  <span class="ruby-ivar">@rss_host</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:rss_host</span>]
  <span class="ruby-ivar">@rss_gems_host</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:rss_gems_host</span>]

  <span class="ruby-ivar">@dest_directory</span> = <span class="ruby-identifier">directory</span>
  <span class="ruby-ivar">@directory</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">Dir</span>.<span class="ruby-identifier">tmpdir</span>, <span class="ruby-node">&quot;gem_generate_index_#{$$}&quot;</span>)

  <span class="ruby-identifier">marshal_name</span> = <span class="ruby-node">&quot;Marshal.#{Gem.marshal_version}&quot;</span>

  <span class="ruby-ivar">@master_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-string">'yaml'</span>
  <span class="ruby-ivar">@marshal_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">marshal_name</span>

  <span class="ruby-ivar">@quick_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-string">'quick'</span>
  <span class="ruby-ivar">@quick_marshal_dir</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-identifier">marshal_name</span>
  <span class="ruby-ivar">@quick_marshal_dir_base</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-string">&quot;quick&quot;</span>, <span class="ruby-identifier">marshal_name</span> <span class="ruby-comment"># FIX: UGH</span>

  <span class="ruby-ivar">@quick_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-string">'index'</span>
  <span class="ruby-ivar">@latest_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_dir</span>, <span class="ruby-string">'latest_index'</span>

  <span class="ruby-ivar">@specs_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-node">&quot;specs.#{Gem.marshal_version}&quot;</span>
  <span class="ruby-ivar">@latest_specs_index</span> =
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@directory</span>, <span class="ruby-node">&quot;latest_specs.#{Gem.marshal_version}&quot;</span>)
  <span class="ruby-ivar">@prerelease_specs_index</span> =
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@directory</span>, <span class="ruby-node">&quot;prerelease_specs.#{Gem.marshal_version}&quot;</span>)
  <span class="ruby-ivar">@dest_specs_index</span> =
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-node">&quot;specs.#{Gem.marshal_version}&quot;</span>)
  <span class="ruby-ivar">@dest_latest_specs_index</span> =
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-node">&quot;latest_specs.#{Gem.marshal_version}&quot;</span>)
  <span class="ruby-ivar">@dest_prerelease_specs_index</span> =
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-node">&quot;prerelease_specs.#{Gem.marshal_version}&quot;</span>)

  <span class="ruby-ivar">@rss_index</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-string">'index.rss'</span>

  <span class="ruby-ivar">@files</span> = []
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                  
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-abbreviate">
            
              <a name="method-i-abbreviate"></a><b>abbreviate</b>(spec)
            
          </div>
          
          
            <div class="description">
              <p>Abbreviate the spec for downloading.  Abbreviated specs are only used for
searching, downloading and related activities and do not need deployment
specific information (e.g. list of files).  So we abbreviate the spec,
making it much smaller for quicker downloads.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-abbreviate_source')" id="l_method-i-abbreviate_source">show</a>
                
              </p>
              <div id="method-i-abbreviate_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 113</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">abbreviate</span>(<span class="ruby-identifier">spec</span>)
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">files</span> = []
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">test_files</span> = []
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">rdoc_options</span> = []
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">extra_rdoc_files</span> = []
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">cert_chain</span> = []
  <span class="ruby-identifier">spec</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-build_indicies">
            
              <a name="method-i-build_indicies"></a><b>build_indicies</b>()
            
          </div>
          
          
            <div class="description">
              <p>Build various indicies</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-build_indicies_source')" id="l_method-i-build_indicies_source">show</a>
                
              </p>
              <div id="method-i-build_indicies_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 125</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">build_indicies</span>
  <span class="ruby-comment"># Marshal gemspecs are used by both modern and legacy RubyGems</span>

  <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">dirs</span> = []
  <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">add_specs</span>(*<span class="ruby-identifier">map_gems_to_specs</span>(<span class="ruby-identifier">gem_file_list</span>))

  <span class="ruby-identifier">build_marshal_gemspecs</span>
  <span class="ruby-identifier">build_legacy_indicies</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@build_legacy</span>
  <span class="ruby-identifier">build_modern_indicies</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@build_modern</span>
  <span class="ruby-identifier">build_rss</span>

  <span class="ruby-identifier">compress_indicies</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-build_legacy_indicies">
            
              <a name="method-i-build_legacy_indicies"></a><b>build_legacy_indicies</b>()
            
          </div>
          
          
            <div class="description">
              <p>Builds indicies for RubyGems older than 1.2.x</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-build_legacy_indicies_source')" id="l_method-i-build_legacy_indicies_source">show</a>
                
              </p>
              <div id="method-i-build_legacy_indicies_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 142</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">build_legacy_indicies</span>
  <span class="ruby-identifier">index</span> = <span class="ruby-identifier">collect_specs</span>

  <span class="ruby-identifier">say</span> <span class="ruby-string">&quot;Generating Marshal master index&quot;</span>

  <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-string">'Generated Marshal master index'</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">open</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-string">'wb'</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">dump</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@marshal_index</span>
  <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@marshal_index}.Z&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-build_marshal_gemspecs">
            
              <a name="method-i-build_marshal_gemspecs"></a><b>build_marshal_gemspecs</b>()
            
          </div>
          
          
            <div class="description">
              <p>Builds <a href="../Marshal.html">Marshal</a> quick index gemspecs.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-build_marshal_gemspecs_source')" id="l_method-i-build_marshal_gemspecs_source">show</a>
                
              </p>
              <div id="method-i-build_marshal_gemspecs_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 160</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">build_marshal_gemspecs</span>
  <span class="ruby-identifier">count</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">count</span>
  <span class="ruby-identifier">progress</span> = <span class="ruby-identifier">ui</span>.<span class="ruby-identifier">progress_reporter</span> <span class="ruby-identifier">count</span>,
                                  <span class="ruby-node">&quot;Generating Marshal quick index gemspecs for #{count} gems&quot;</span>,
                                  <span class="ruby-string">&quot;Complete&quot;</span>

  <span class="ruby-identifier">files</span> = []

  <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-string">'Generated Marshal quick index gemspecs'</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">spec_file_name</span> = <span class="ruby-node">&quot;#{spec.original_name}.gemspec.rz&quot;</span>
      <span class="ruby-identifier">marshal_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@quick_marshal_dir</span>, <span class="ruby-identifier">spec_file_name</span>

      <span class="ruby-identifier">marshal_zipped</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">deflate</span> <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">spec</span>)
      <span class="ruby-identifier">open</span> <span class="ruby-identifier">marshal_name</span>, <span class="ruby-string">'wb'</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">marshal_zipped</span> <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">marshal_name</span>

      <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">updated</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">progress</span>.<span class="ruby-identifier">done</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@quick_marshal_dir</span>

  <span class="ruby-identifier">files</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-build_modern_index">
            
              <a name="method-i-build_modern_index"></a><b>build_modern_index</b>(index, file, name)
            
          </div>
          
          
            <div class="description">
              <p>Build a single index for RubyGems 1.2 and newer</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-build_modern_index_source')" id="l_method-i-build_modern_index_source">show</a>
                
              </p>
              <div id="method-i-build_modern_index_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 192</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">build_modern_index</span>(<span class="ruby-identifier">index</span>, <span class="ruby-identifier">file</span>, <span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Generating #{name} index&quot;</span>

  <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-node">&quot;Generated #{name} index&quot;</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">open</span>(<span class="ruby-identifier">file</span>, <span class="ruby-string">'wb'</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">specs</span> = <span class="ruby-identifier">index</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span>*<span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
        <span class="ruby-comment"># We have to splat here because latest_specs is an array, while the</span>
        <span class="ruby-comment"># others are hashes.</span>
        <span class="ruby-identifier">spec</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">last</span>
        <span class="ruby-identifier">platform</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_platform</span>

        <span class="ruby-comment"># win32-api-1.0.4-x86-mswin32-60</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">platform</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;Skipping invalid platform in gem: #{spec.full_name}&quot;</span>
          <span class="ruby-keyword">next</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">platform</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Platform</span><span class="ruby-operator">::</span><span class="ruby-constant">RUBY</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">empty?</span>
        [<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>]
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">specs</span> = <span class="ruby-identifier">compact_specs</span>(<span class="ruby-identifier">specs</span>)
      <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">specs</span>, <span class="ruby-identifier">io</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-build_modern_indicies">
            
              <a name="method-i-build_modern_indicies"></a><b>build_modern_indicies</b>()
            
          </div>
          
          
            <div class="description">
              <p>Builds indicies for RubyGems 1.2 and newer. Handles full, latest,
prerelease</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-build_modern_indicies_source')" id="l_method-i-build_modern_indicies_source">show</a>
                
              </p>
              <div id="method-i-build_modern_indicies_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 222</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">build_modern_indicies</span>
  <span class="ruby-identifier">prerelease</span>, <span class="ruby-identifier">released</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">partition</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">s</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">prerelease?</span>
  }
  <span class="ruby-identifier">latest_specs</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">latest_specs</span>

  <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">released</span>.<span class="ruby-identifier">sort</span>, <span class="ruby-ivar">@specs_index</span>, <span class="ruby-string">'specs'</span>)
  <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">latest_specs</span>.<span class="ruby-identifier">sort</span>, <span class="ruby-ivar">@latest_specs_index</span>, <span class="ruby-string">'latest specs'</span>)
  <span class="ruby-identifier">build_modern_index</span>(<span class="ruby-identifier">prerelease</span>.<span class="ruby-identifier">sort</span>, <span class="ruby-ivar">@prerelease_specs_index</span>,
                     <span class="ruby-string">'prerelease specs'</span>)

  <span class="ruby-ivar">@files</span> <span class="ruby-operator">+=</span> [<span class="ruby-ivar">@specs_index</span>,
             <span class="ruby-node">&quot;#{@specs_index}.gz&quot;</span>,
             <span class="ruby-ivar">@latest_specs_index</span>,
             <span class="ruby-node">&quot;#{@latest_specs_index}.gz&quot;</span>,
             <span class="ruby-ivar">@prerelease_specs_index</span>,
             <span class="ruby-node">&quot;#{@prerelease_specs_index}.gz&quot;</span>]
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-build_rss">
            
              <a name="method-i-build_rss"></a><b>build_rss</b>()
            
          </div>
          
          
            <div class="description">
              <p>Builds an <a href="../RSS.html">RSS</a> feed for past two days gem releases
according to the gem’s date.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-build_rss_source')" id="l_method-i-build_rss_source">show</a>
                
              </p>
              <div id="method-i-build_rss_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 245</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">build_rss</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@rss_host</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@rss_gems_host</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">alert_warning</span> <span class="ruby-string">&quot;no --rss-host or --rss-gems-host, RSS generation disabled&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">return</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">require</span> <span class="ruby-string">'cgi'</span>
    <span class="ruby-identifier">require</span> <span class="ruby-string">'rubygems/text'</span>

    <span class="ruby-identifier">extend</span> <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Text</span>

    <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-string">'Generated rss'</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">open</span> <span class="ruby-ivar">@rss_index</span>, <span class="ruby-string">'wb'</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">rss_host</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span> <span class="ruby-ivar">@rss_host</span>
        <span class="ruby-identifier">rss_title</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span>(<span class="ruby-ivar">@rss_title</span> <span class="ruby-operator">||</span> <span class="ruby-string">'gems'</span>)

        <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;rss version=&quot;2.0&quot;&gt;
  &lt;channel&gt;
    &lt;title&gt;#{rss_title}&lt;/title&gt;
    &lt;link&gt;http://#{rss_host}&lt;/link&gt;
    &lt;description&gt;Recently released gems from http://#{rss_host}&lt;/description&gt;
    &lt;generator&gt;RubyGems v#{Gem::VERSION}&lt;/generator&gt;
    &lt;docs&gt;http://cyber.law.harvard.edu/rss/rss.html&lt;/docs&gt;
&quot;</span>

        <span class="ruby-identifier">today</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span><span class="ruby-operator">::</span><span class="ruby-constant">TODAY</span>
        <span class="ruby-identifier">yesterday</span> = <span class="ruby-identifier">today</span> <span class="ruby-operator">-</span> <span class="ruby-number">86400</span>

        <span class="ruby-identifier">index</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Specification</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">spec_date</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">date</span>
          <span class="ruby-comment"># TODO: remove this and make YAML based specs properly normalized</span>
          <span class="ruby-identifier">spec_date</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">spec_date</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Date</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">spec_date</span>

          <span class="ruby-identifier">spec_date</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">yesterday</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">spec_date</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">today</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">index</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">spec</span>.<span class="ruby-identifier">date</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">spec</span>] }.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">file_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">cache_file</span>
          <span class="ruby-identifier">gem_path</span> = <span class="ruby-constant">CGI</span>.<span class="ruby-identifier">escapeHTML</span> <span class="ruby-node">&quot;http://#{@rss_gems_host}/gems/#{file_name}&quot;</span>
          <span class="ruby-identifier">size</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">loaded_from</span>).<span class="ruby-identifier">size</span> <span class="ruby-comment"># rescue next</span>

          <span class="ruby-identifier">description</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span> <span class="ruby-operator">||</span> <span class="ruby-string">''</span>
          <span class="ruby-identifier">authors</span> = <span class="ruby-constant">Array</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span>
          <span class="ruby-identifier">emails</span> = <span class="ruby-constant">Array</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">email</span>
          <span class="ruby-identifier">authors</span> = <span class="ruby-identifier">emails</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-identifier">authors</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">email</span>, <span class="ruby-identifier">author</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">email</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; (#{author})&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">author</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">author</span>.<span class="ruby-identifier">empty?</span>
          <span class="ruby-keyword">end</span>.<span class="ruby-identifier">join</span> <span class="ruby-string">', '</span>

          <span class="ruby-identifier">description</span> = <span class="ruby-identifier">description</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\n\n+/</span>).<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">chunk</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">format_text</span> <span class="ruby-identifier">chunk</span>, <span class="ruby-number">78</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-identifier">description</span> = <span class="ruby-identifier">description</span>.<span class="ruby-identifier">join</span> <span class="ruby-string">&quot;\n\n&quot;</span>

          <span class="ruby-identifier">item</span> = <span class="ruby-string">''</span>

          <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;    &lt;item&gt;
      &lt;title&gt;#{CGI.escapeHTML spec.full_name}&lt;/title&gt;
      &lt;description&gt;
&amp;lt;pre&amp;gt;#{CGI.escapeHTML description.chomp}&amp;lt;/pre&amp;gt;
      &lt;/description&gt;
      &lt;author&gt;#{CGI.escapeHTML authors}&lt;/author&gt;
      &lt;guid&gt;#{CGI.escapeHTML spec.full_name}&lt;/guid&gt;
      &lt;enclosure url=\&quot;#{gem_path}\&quot;
                 length=\&quot;#{size}\&quot; type=\&quot;application/octet-stream\&quot; /&gt;
      &lt;pubDate&gt;#{spec.date.rfc2822}&lt;/pubDate&gt;
&quot;</span>

          <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;      &lt;link&gt;#{CGI.escapeHTML spec.homepage}&lt;/link&gt;
&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">homepage</span>

          <span class="ruby-identifier">item</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;    &lt;/item&gt;
&quot;</span>

          <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">item</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">io</span>.<span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;  &lt;/channel&gt;
&lt;/rss&gt;
&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-ivar">@files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@rss_index</span>
  <span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-collect_specs">
            
              <a name="method-i-collect_specs"></a><b>collect_specs</b>(gems = gem_file_list)
            
          </div>
          
          
            <div class="description">
              <p>Collect specifications from .gem files from the gem directory.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-collect_specs_source')" id="l_method-i-collect_specs_source">show</a>
                
              </p>
              <div id="method-i-collect_specs_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 379</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">collect_specs</span>(<span class="ruby-identifier">gems</span> = <span class="ruby-identifier">gem_file_list</span>)
  <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Deprecate</span>.<span class="ruby-identifier">skip_during</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">index</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">SourceIndex</span>.<span class="ruby-identifier">new</span>

    <span class="ruby-identifier">map_gems_to_specs</span>(<span class="ruby-identifier">gems</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">index</span>.<span class="ruby-identifier">add_spec</span> <span class="ruby-identifier">spec</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_name</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">index</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-compact_specs">
            
              <a name="method-i-compact_specs"></a><b>compact_specs</b>(specs)
            
          </div>
          
          
            <div class="description">
              <p>Compacts <a href="../Marshal.html">Marshal</a> output for the specs index
data source by using identical objects as much as possible.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-compact_specs_source')" id="l_method-i-compact_specs_source">show</a>
                
              </p>
              <div id="method-i-compact_specs_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 417</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">compact_specs</span>(<span class="ruby-identifier">specs</span>)
  <span class="ruby-identifier">names</span> = {}
  <span class="ruby-identifier">versions</span> = {}
  <span class="ruby-identifier">platforms</span> = {}

  <span class="ruby-identifier">specs</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>)<span class="ruby-operator">|</span>
    <span class="ruby-identifier">names</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">name</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">names</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">name</span>
    <span class="ruby-identifier">versions</span>[<span class="ruby-identifier">version</span>] = <span class="ruby-identifier">version</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">versions</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">version</span>
    <span class="ruby-identifier">platforms</span>[<span class="ruby-identifier">platform</span>] = <span class="ruby-identifier">platform</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">platforms</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">platform</span>

    [<span class="ruby-identifier">names</span>[<span class="ruby-identifier">name</span>], <span class="ruby-identifier">versions</span>[<span class="ruby-identifier">version</span>], <span class="ruby-identifier">platforms</span>[<span class="ruby-identifier">platform</span>]]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-compress">
            
              <a name="method-i-compress"></a><b>compress</b>(filename, extension)
            
          </div>
          
          
            <div class="description">
              <p>Compress <code>filename</code> with <code>extension</code>.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-compress_source')" id="l_method-i-compress_source">show</a>
                
              </p>
              <div id="method-i-compress_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 434</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">compress</span>(<span class="ruby-identifier">filename</span>, <span class="ruby-identifier">extension</span>)
  <span class="ruby-identifier">data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-identifier">filename</span>

  <span class="ruby-identifier">zipped</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">deflate</span> <span class="ruby-identifier">data</span>

  <span class="ruby-identifier">open</span> <span class="ruby-node">&quot;#{filename}.#{extension}&quot;</span>, <span class="ruby-string">'wb'</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">zipped</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-compress_indicies">
            
              <a name="method-i-compress_indicies"></a><b>compress_indicies</b>()
            
          </div>
          
          
            <div class="description">
              <p>Compresses indicies on disk</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-compress_indicies_source')" id="l_method-i-compress_indicies_source">show</a>
                
              </p>
              <div id="method-i-compress_indicies_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 396</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">compress_indicies</span>
  <span class="ruby-identifier">say</span> <span class="ruby-string">&quot;Compressing indicies&quot;</span>

  <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-string">'Compressed indicies'</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@build_legacy</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">compress</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-string">'Z'</span>
      <span class="ruby-identifier">paranoid</span> <span class="ruby-ivar">@marshal_index</span>, <span class="ruby-string">'Z'</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@build_modern</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@specs_index</span>
      <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@latest_specs_index</span>
      <span class="ruby-identifier">gzip</span> <span class="ruby-ivar">@prerelease_specs_index</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-gem_file_list">
            
              <a name="method-i-gem_file_list"></a><b>gem_file_list</b>()
            
          </div>
          
          
            <div class="description">
              <p>List of gem file names to index.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-gem_file_list_source')" id="l_method-i-gem_file_list_source">show</a>
                
              </p>
              <div id="method-i-gem_file_list_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 447</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">gem_file_list</span>
  <span class="ruby-constant">Dir</span>[<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-string">&quot;gems&quot;</span>, <span class="ruby-string">'*.gem'</span>)]
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-generate_index">
            
              <a name="method-i-generate_index"></a><b>generate_index</b>()
            
          </div>
          
          
            <div class="description">
              <p>Builds and installs indicies.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-generate_index_source')" id="l_method-i-generate_index_source">show</a>
                
              </p>
              <div id="method-i-generate_index_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 454</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">generate_index</span>
  <span class="ruby-identifier">make_temp_directories</span>
  <span class="ruby-identifier">build_indicies</span>
  <span class="ruby-identifier">install_indicies</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">SignalException</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-ivar">@directory</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-gzip">
            
              <a name="method-i-gzip"></a><b>gzip</b>(filename)
            
          </div>
          
          
            <div class="description">
              <p><a href="../Zlib/GzipWriter.html">Zlib::GzipWriter</a> wrapper that gzips
<code>filename</code> on disk.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-gzip_source')" id="l_method-i-gzip_source">show</a>
                
              </p>
              <div id="method-i-gzip_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 466</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">gzip</span>(<span class="ruby-identifier">filename</span>)
  <span class="ruby-constant">Zlib</span><span class="ruby-operator">::</span><span class="ruby-constant">GzipWriter</span>.<span class="ruby-identifier">open</span> <span class="ruby-node">&quot;#{filename}.gz&quot;</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">io</span>.<span class="ruby-identifier">write</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span>(<span class="ruby-identifier">filename</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-install_indicies">
            
              <a name="method-i-install_indicies"></a><b>install_indicies</b>()
            
          </div>
          
          
            <div class="description">
              <p>Install generated indicies into the destination directory.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-install_indicies_source')" id="l_method-i-install_indicies_source">show</a>
                
              </p>
              <div id="method-i-install_indicies_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 475</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">install_indicies</span>
  <span class="ruby-identifier">verbose</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span>

  <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Moving index into production dir #{@dest_directory}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">verbose</span>

  <span class="ruby-identifier">files</span> = <span class="ruby-ivar">@files</span>
  <span class="ruby-identifier">files</span>.<span class="ruby-identifier">delete</span> <span class="ruby-ivar">@quick_marshal_dir</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_dir</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_marshal_dir</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">files</span>.<span class="ruby-identifier">include?</span> <span class="ruby-ivar">@quick_dir</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">files</span>.<span class="ruby-identifier">delete</span> <span class="ruby-ivar">@quick_marshal_dir</span>

    <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-ivar">@dest_directory</span>, <span class="ruby-ivar">@quick_marshal_dir_base</span>)

    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">dirname</span>(<span class="ruby-identifier">dst_name</span>), <span class="ruby-value">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-identifier">dst_name</span>, <span class="ruby-value">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span>(<span class="ruby-ivar">@quick_marshal_dir</span>, <span class="ruby-identifier">dst_name</span>,
                 <span class="ruby-value">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>, <span class="ruby-value">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">files</span> = <span class="ruby-identifier">files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">/^#{Regexp.escape @directory}\/?/</span>, <span class="ruby-string">''</span>) <span class="ruby-comment"># HACK?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">src_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">file</span>
    <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>, <span class="ruby-identifier">file</span>

    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-identifier">dst_name</span>, <span class="ruby-value">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span>(<span class="ruby-identifier">src_name</span>, <span class="ruby-ivar">@dest_directory</span>,
                 <span class="ruby-value">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>, <span class="ruby-value">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-make_temp_directories">
            
              <a name="method-i-make_temp_directories"></a><b>make_temp_directories</b>()
            
          </div>
          
          
            <div class="description">
              <p>Make directories for index generation</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-make_temp_directories_source')" id="l_method-i-make_temp_directories_source">show</a>
                
              </p>
              <div id="method-i-make_temp_directories_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 511</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">make_temp_directories</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_rf</span> <span class="ruby-ivar">@directory</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-value">:mode</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-number">0700</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-ivar">@quick_marshal_dir</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-map_gems_to_specs">
            
              <a name="method-i-map_gems_to_specs"></a><b>map_gems_to_specs</b>(gems)
            
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-map_gems_to_specs_source')" id="l_method-i-map_gems_to_specs_source">show</a>
                
              </p>
              <div id="method-i-map_gems_to_specs_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 339</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">map_gems_to_specs</span> <span class="ruby-identifier">gems</span>
  <span class="ruby-identifier">gems</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">gemfile</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">size</span>(<span class="ruby-identifier">gemfile</span>) <span class="ruby-operator">==</span> <span class="ruby-number">0</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">alert_warning</span> <span class="ruby-node">&quot;Skipping zero-length gem: #{gemfile}&quot;</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">spec</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Format</span>.<span class="ruby-identifier">from_file_by_path</span>(<span class="ruby-identifier">gemfile</span>).<span class="ruby-identifier">spec</span>
      <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">loaded_from</span> = <span class="ruby-identifier">gemfile</span>

      <span class="ruby-comment"># HACK: fuck this shit - borks all tests that use pl1</span>
      <span class="ruby-comment"># if File.basename(gemfile, &quot;.gem&quot;) != spec.original_name then</span>
      <span class="ruby-comment">#   exp = spec.full_name</span>
      <span class="ruby-comment">#   exp &lt;&lt; &quot; (#{spec.original_name})&quot; if</span>
      <span class="ruby-comment">#     spec.original_name != spec.full_name</span>
      <span class="ruby-comment">#   msg = &quot;Skipping misnamed gem: #{gemfile} should be named #{exp}&quot;</span>
      <span class="ruby-comment">#   alert_warning msg</span>
      <span class="ruby-comment">#   next</span>
      <span class="ruby-comment"># end</span>

      <span class="ruby-identifier">abbreviate</span> <span class="ruby-identifier">spec</span>
      <span class="ruby-identifier">sanitize</span> <span class="ruby-identifier">spec</span>

      <span class="ruby-identifier">spec</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">SignalException</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-identifier">alert_error</span> <span class="ruby-string">&quot;Received signal, exiting&quot;</span>
      <span class="ruby-identifier">raise</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
      <span class="ruby-identifier">msg</span> = [<span class="ruby-node">&quot;Unable to process #{gemfile}&quot;</span>,
             <span class="ruby-node">&quot;#{e.message} (#{e.class})&quot;</span>,
             <span class="ruby-node">&quot;\t#{e.backtrace.join &quot;\n\t&quot;}&quot;</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)
      <span class="ruby-identifier">alert_error</span> <span class="ruby-identifier">msg</span>
    <span class="ruby-keyword">end</span>
  }.<span class="ruby-identifier">compact</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-paranoid">
            
              <a name="method-i-paranoid"></a><b>paranoid</b>(path, extension)
            
          </div>
          
          
            <div class="description">
              <p>Ensure <code>path</code> and path with <code>extension</code> are
identical.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-paranoid_source')" id="l_method-i-paranoid_source">show</a>
                
              </p>
              <div id="method-i-paranoid_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 520</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">paranoid</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">extension</span>)
  <span class="ruby-identifier">data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-identifier">path</span>
  <span class="ruby-identifier">compressed_data</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span> <span class="ruby-node">&quot;#{path}.#{extension}&quot;</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">data</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">inflate</span>(<span class="ruby-identifier">compressed_data</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Compressed file #{compressed_path} does not match uncompressed file #{path}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-sanitize">
            
              <a name="method-i-sanitize"></a><b>sanitize</b>(spec)
            
          </div>
          
          
            <div class="description">
              <p>Sanitize the descriptive fields in the spec.  Sometimes non-ASCII
characters will garble the site index.  Non-ASCII characters will be
replaced by their <a href="../XML.html">XML</a> entity equivalent.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-sanitize_source')" id="l_method-i-sanitize_source">show</a>
                
              </p>
              <div id="method-i-sanitize_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 534</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">sanitize</span>(<span class="ruby-identifier">spec</span>)
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span>              = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">summary</span>)
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span>          = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">description</span>)
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">post_install_message</span> = <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">post_install_message</span>)
  <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span>              = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">authors</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sanitize_string</span>(<span class="ruby-identifier">a</span>) }

  <span class="ruby-identifier">spec</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-sanitize_string">
            
              <a name="method-i-sanitize_string"></a><b>sanitize_string</b>(string)
            
          </div>
          
          
            <div class="description">
              <p>Sanitize a single string.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-sanitize_string_source')" id="l_method-i-sanitize_string_source">show</a>
                
              </p>
              <div id="method-i-sanitize_string_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 546</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">sanitize_string</span>(<span class="ruby-identifier">string</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">string</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">string</span>

  <span class="ruby-comment"># HACK the #to_s is in here because RSpec has an Array of Arrays of</span>
  <span class="ruby-comment"># Strings for authors.  Need a way to disallow bad values on gemspec</span>
  <span class="ruby-comment"># generation.  (Probably won't happen.)</span>
  <span class="ruby-identifier">string</span> = <span class="ruby-identifier">string</span>.<span class="ruby-identifier">to_s</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-constant">Builder</span><span class="ruby-operator">::</span><span class="ruby-constant">XChar</span>.<span class="ruby-identifier">encode</span> <span class="ruby-identifier">string</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">NameError</span>, <span class="ruby-constant">NoMethodError</span>
    <span class="ruby-identifier">string</span>.<span class="ruby-identifier">to_xs</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-update_index">
            
              <a name="method-i-update_index"></a><b>update_index</b>()
            
          </div>
          
          
            <div class="description">
              <p>Perform an in-place update of the repository from newly added gems.  Only
works for modern indicies, and sets <a
href="Indexer.html#attribute-i-build_legacy">#build_legacy</a> to false
when run.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-update_index_source')" id="l_method-i-update_index_source">show</a>
                
              </p>
              <div id="method-i-update_index_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 565</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">update_index</span>
  <span class="ruby-ivar">@build_legacy</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-identifier">make_temp_directories</span>

  <span class="ruby-identifier">specs_mtime</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-ivar">@dest_specs_index</span>).<span class="ruby-identifier">mtime</span>
  <span class="ruby-identifier">newest_mtime</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">at</span> <span class="ruby-number">0</span>

  <span class="ruby-identifier">updated_gems</span> = <span class="ruby-identifier">gem_file_list</span>.<span class="ruby-identifier">select</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">gem</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">gem_mtime</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">stat</span>(<span class="ruby-identifier">gem</span>).<span class="ruby-identifier">mtime</span>
    <span class="ruby-identifier">newest_mtime</span> = <span class="ruby-identifier">gem_mtime</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">gem_mtime</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">newest_mtime</span>
    <span class="ruby-identifier">gem_mtime</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">specs_mtime</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">updated_gems</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">say</span> <span class="ruby-string">'No new gems'</span>
    <span class="ruby-identifier">terminate_interaction</span> <span class="ruby-number">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">specs</span> = <span class="ruby-identifier">map_gems_to_specs</span> <span class="ruby-identifier">updated_gems</span>
  <span class="ruby-identifier">prerelease</span>, <span class="ruby-identifier">released</span> = <span class="ruby-identifier">specs</span>.<span class="ruby-identifier">partition</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">version</span>.<span class="ruby-identifier">prerelease?</span> }

  <span class="ruby-identifier">files</span> = <span class="ruby-identifier">build_marshal_gemspecs</span>

  <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">time</span> <span class="ruby-string">'Updated indexes'</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">update_specs_index</span> <span class="ruby-identifier">released</span>, <span class="ruby-ivar">@dest_specs_index</span>, <span class="ruby-ivar">@specs_index</span>
    <span class="ruby-identifier">update_specs_index</span> <span class="ruby-identifier">released</span>, <span class="ruby-ivar">@dest_latest_specs_index</span>, <span class="ruby-ivar">@latest_specs_index</span>
    <span class="ruby-identifier">update_specs_index</span>(<span class="ruby-identifier">prerelease</span>,
                       <span class="ruby-ivar">@dest_prerelease_specs_index</span>,
                       <span class="ruby-ivar">@prerelease_specs_index</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">compress_indicies</span>

  <span class="ruby-identifier">verbose</span> = <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">configuration</span>.<span class="ruby-identifier">really_verbose</span>

  <span class="ruby-identifier">say</span> <span class="ruby-node">&quot;Updating production dir #{@dest_directory}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">verbose</span>

  <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@specs_index</span>
  <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@specs_index}.gz&quot;</span>
  <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@latest_specs_index</span>
  <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@latest_specs_index}.gz&quot;</span>
  <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@prerelease_specs_index</span>
  <span class="ruby-identifier">files</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{@prerelease_specs_index}.gz&quot;</span>

  <span class="ruby-identifier">files</span> = <span class="ruby-identifier">files</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">path</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">/^#{Regexp.escape @directory}\/?/</span>, <span class="ruby-string">''</span>) <span class="ruby-comment"># HACK?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">src_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@directory</span>, <span class="ruby-identifier">file</span>
    <span class="ruby-identifier">dst_name</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span> <span class="ruby-ivar">@dest_directory</span>, <span class="ruby-identifier">file</span> <span class="ruby-comment"># REFACTOR: duped above</span>

    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mv</span> <span class="ruby-identifier">src_name</span>, <span class="ruby-identifier">dst_name</span>, <span class="ruby-value">:verbose</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">verbose</span>,
                 <span class="ruby-value">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span>

    <span class="ruby-constant">File</span>.<span class="ruby-identifier">utime</span> <span class="ruby-identifier">newest_mtime</span>, <span class="ruby-identifier">newest_mtime</span>, <span class="ruby-identifier">dst_name</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-update_specs_index">
            
              <a name="method-i-update_specs_index"></a><b>update_specs_index</b>(index, source, dest)
            
          </div>
          
          
            <div class="description">
              <p>Combines specs in <code>index</code> and <code>source</code> then writes
out a new copy to <code>dest</code>.  For a latest index, does not ensure
the new file is minimal.</p>
            </div>
          
          
          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-update_specs_index_source')" id="l_method-i-update_specs_index_source">show</a>
                
              </p>
              <div id="method-i-update_specs_index_source" class="dyn-source">
                <pre><span class="ruby-comment"># File lib/rubygems/indexer.rb, line 629</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">update_specs_index</span>(<span class="ruby-identifier">index</span>, <span class="ruby-identifier">source</span>, <span class="ruby-identifier">dest</span>)
  <span class="ruby-identifier">specs_index</span> = <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">load</span> <span class="ruby-constant">Gem</span>.<span class="ruby-identifier">read_binary</span>(<span class="ruby-identifier">source</span>)

  <span class="ruby-identifier">index</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">spec</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">platform</span> = <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">original_platform</span>
    <span class="ruby-identifier">platform</span> = <span class="ruby-constant">Gem</span><span class="ruby-operator">::</span><span class="ruby-constant">Platform</span><span class="ruby-operator">::</span><span class="ruby-constant">RUBY</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">platform</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">specs_index</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">spec</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">spec</span>.<span class="ruby-identifier">version</span>, <span class="ruby-identifier">platform</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">specs_index</span> = <span class="ruby-identifier">compact_specs</span> <span class="ruby-identifier">specs_index</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>

  <span class="ruby-identifier">open</span> <span class="ruby-identifier">dest</span>, <span class="ruby-string">'wb'</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">Marshal</span>.<span class="ruby-identifier">dump</span> <span class="ruby-identifier">specs_index</span>, <span class="ruby-identifier">io</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>
    </div>
  </body>
</html>    