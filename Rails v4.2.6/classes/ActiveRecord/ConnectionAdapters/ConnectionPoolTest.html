<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>ActiveRecord::ConnectionAdapters::ConnectionPoolTest</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/github.css" type="text/css" media="screen" />
<script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Class</span> 
            ActiveRecord::ConnectionAdapters::ConnectionPoolTest 
            
                <span class="parent">&lt; 
                    
                    ActiveRecord::TestCase
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/activerecord/test/cases/connection_pool_test_rb.html">activerecord/test/cases/connection_pool_test.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-active_connections">active_connections</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-setup">setup</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-test_active_connection-3F">test_active_connection?</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_active_connection_in_use">test_active_connection_in_use</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_anonymous_class_exception">test_anonymous_class_exception</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_automatic_reconnect-3D">test_automatic_reconnect=</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_checkout_after_close">test_checkout_after_close</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_checkout_behaviour">test_checkout_behaviour</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_checkout_fairness">test_checkout_fairness</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_checkout_fairness_by_group">test_checkout_fairness_by_group</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_full_pool_blocks">test_full_pool_blocks</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_full_pool_exception">test_full_pool_exception</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_pool_sets_connection_visitor">test_pool_sets_connection_visitor</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_reap_and_active">test_reap_and_active</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_reap_inactive">test_reap_inactive</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_released_connection_moves_between_threads">test_released_connection_moves_between_threads</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_remove_connection">test_remove_connection</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_remove_connection_for_thread">test_remove_connection_for_thread</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_removing_releases_latch">test_removing_releases_latch</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_with_connection">test_with_connection</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    
      <!-- Section attributes -->
      <div class="sectiontitle">Attributes</div>
      <table border='0' cellpadding='5'>
        
          <tr valign='top'>
            <td class='attr-rw'>
              [R]
            </td>
            <td class='attr-name'>pool</td>
            <td class='attr-desc'></td>
          </tr>
        
      </table>
    


    <!-- Methods -->
        
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-active_connections">
            
              <b>active_connections</b>(pool)
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-active_connections" name="method-i-active_connections" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-active_connections_source')" id="l_method-i-active_connections_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L30" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-active_connections_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 30</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">active_connections</span>(<span class="ruby-identifier">pool</span>)
  <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connections</span>.<span class="ruby-identifier">find_all</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:in_use?</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-setup">
            
              <b>setup</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-setup" name="method-i-setup" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-setup_source')" id="l_method-i-setup_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L9" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-setup_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 9</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">setup</span>
  <span class="ruby-keyword">super</span>

  <span class="ruby-comment"># Keep a duplicate pool so we do not bother others</span>
  <span class="ruby-ivar">@pool</span> = <span class="ruby-constant">ConnectionPool</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection_pool</span>.<span class="ruby-identifier">spec</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_memory_db?</span>
    <span class="ruby-comment"># Separate connections to an in-memory database create an entirely new database,</span>
    <span class="ruby-comment"># with an empty schema etc, so we just stub out this schema on the fly.</span>
    <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">with_connection</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">connection</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">create_table</span> <span class="ruby-value">:posts</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> <span class="ruby-value">:cololumn</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_active_connection-3F">
            
              <b>test_active_connection?</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_active_connection-3F" name="method-i-test_active_connection-3F" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_active_connection-3F_source')" id="l_method-i-test_active_connection-3F_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L177" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_active_connection-3F_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 177</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_active_connection?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">active_connection?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">active_connection?</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">release_connection</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">active_connection?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_active_connection_in_use">
            
              <b>test_active_connection_in_use</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_active_connection_in_use" name="method-i-test_active_connection_in_use" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_active_connection_in_use_source')" id="l_method-i-test_active_connection_in_use_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L80" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_active_connection_in_use_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 80</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_active_connection_in_use</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pool</span>.<span class="ruby-identifier">active_connection?</span>
  <span class="ruby-identifier">main_thread</span> = <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">active_connection?</span>

  <span class="ruby-identifier">main_thread</span>.<span class="ruby-identifier">close</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">pool</span>.<span class="ruby-identifier">active_connection?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_anonymous_class_exception">
            
              <b>test_anonymous_class_exception</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_anonymous_class_exception" name="method-i-test_anonymous_class_exception" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>make sure exceptions are thrown when establish_connection is called with an
anonymous class</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_anonymous_class_exception_source')" id="l_method-i-test_anonymous_class_exception_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L336" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_anonymous_class_exception_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 336</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_anonymous_class_exception</span>
  <span class="ruby-identifier">anonymous</span> = <span class="ruby-constant">Class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>)
  <span class="ruby-identifier">handler</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection_handler</span>

  <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">RuntimeError</span>) {
    <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">establish_connection</span> <span class="ruby-identifier">anonymous</span>, <span class="ruby-keyword">nil</span>
  }
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_automatic_reconnect-3D">
            
              <b>test_automatic_reconnect=</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_automatic_reconnect-3D" name="method-i-test_automatic_reconnect-3D" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_automatic_reconnect-3D_source')" id="l_method-i-test_automatic_reconnect-3D_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L310" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_automatic_reconnect-3D_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 310</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_automatic_reconnect=</span>
  <span class="ruby-identifier">pool</span> = <span class="ruby-constant">ConnectionPool</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection_pool</span>.<span class="ruby-identifier">spec</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">automatic_reconnect</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>

  <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">disconnect!</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>

  <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">disconnect!</span>
  <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">automatic_reconnect</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">ConnectionNotEstablished</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">ConnectionNotEstablished</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">with_connection</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_checkout_after_close">
            
              <b>test_checkout_after_close</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_checkout_after_close" name="method-i-test_checkout_after_close" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_checkout_after_close_source')" id="l_method-i-test_checkout_after_close_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L34" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_checkout_after_close_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 34</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_checkout_after_close</span>
  <span class="ruby-identifier">connection</span> = <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">in_use?</span>

  <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">connection</span>.<span class="ruby-identifier">in_use?</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">in_use?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_checkout_behaviour">
            
              <b>test_checkout_behaviour</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_checkout_behaviour" name="method-i-test_checkout_behaviour" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_checkout_behaviour_source')" id="l_method-i-test_checkout_behaviour_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L185" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_checkout_behaviour_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_checkout_behaviour</span>
  <span class="ruby-identifier">pool</span> = <span class="ruby-constant">ConnectionPool</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection_pool</span>.<span class="ruby-identifier">spec</span>
  <span class="ruby-identifier">connection</span> = <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">assert_not_nil</span> <span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">threads</span> = []
  <span class="ruby-number">4</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">threads</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">i</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">connection</span> = <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>
      <span class="ruby-identifier">assert_not_nil</span> <span class="ruby-identifier">connection</span>
      <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">close</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">threads</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:join</span>)

  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>
    <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-keyword">end</span>.<span class="ruby-identifier">join</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_checkout_fairness">
            
              <b>test_checkout_fairness</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_checkout_fairness" name="method-i-test_checkout_fairness" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>The connection pool is “fair” if threads waiting for connections receive
them the order in which they began waiting.  This ensures that we don&#39;t
timeout one HTTP request even while well under capacity in a multi-threaded
environment such as a Java servlet container.</p>

<p>We don&#39;t need strict fairness: if two connections become available at
the same time, it&#39;s fine of two threads that were waiting acquire the
connections out of order.</p>

<p>Thus this test prepares waiting threads and then trickles in available
connections slowly, ensuring the wakeup order is correct in this case.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_checkout_fairness_source')" id="l_method-i-test_checkout_fairness_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L219" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_checkout_fairness_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 219</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_checkout_fairness</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value">:@size</span>, <span class="ruby-number">10</span>)
  <span class="ruby-identifier">expected</span> = (<span class="ruby-number">1</span><span class="ruby-operator">..</span><span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">size</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">freeze</span>
  <span class="ruby-comment"># check out all connections so our threads start out waiting</span>
  <span class="ruby-identifier">conns</span> = <span class="ruby-identifier">expected</span>.<span class="ruby-identifier">map</span> { <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> }
  <span class="ruby-identifier">mutex</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">order</span> = []
  <span class="ruby-identifier">errors</span> = []

  <span class="ruby-identifier">threads</span> = <span class="ruby-identifier">expected</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">t</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
      <span class="ruby-keyword">begin</span>
        <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> <span class="ruby-comment"># never checked back in</span>
        <span class="ruby-identifier">mutex</span>.<span class="ruby-identifier">synchronize</span> { <span class="ruby-identifier">order</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">i</span> }
      <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-identifier">mutex</span>.<span class="ruby-identifier">synchronize</span> { <span class="ruby-identifier">errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">e</span> }
      <span class="ruby-keyword">end</span>
    }
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">pass</span> <span class="ruby-keyword">until</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;sleep&quot;</span>
    <span class="ruby-identifier">t</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># this should wake up the waiting threads one by one in order</span>
  <span class="ruby-identifier">conns</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkin</span>(<span class="ruby-identifier">conn</span>); <span class="ruby-identifier">sleep</span> <span class="ruby-number">0.1</span> }

  <span class="ruby-identifier">threads</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:join</span>)

  <span class="ruby-identifier">raise</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">any?</span>

  <span class="ruby-identifier">assert_equal</span>(<span class="ruby-identifier">expected</span>, <span class="ruby-identifier">order</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_checkout_fairness_by_group">
            
              <b>test_checkout_fairness_by_group</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_checkout_fairness_by_group" name="method-i-test_checkout_fairness_by_group" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>As mentioned in <a
href="ConnectionPoolTest.html#method-i-test_checkout_fairness">test_checkout_fairness</a>,
we don&#39;t care about strict fairness.  This test creates two groups of
threads: group1 whose members all start waiting before any thread in
group2.  Enough connections are checked in to wakeup all group1 threads,
and the fact that only group1 and no group2 threads acquired a connection
is enforced.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_checkout_fairness_by_group_source')" id="l_method-i-test_checkout_fairness_by_group_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L257" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_checkout_fairness_by_group_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 257</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_checkout_fairness_by_group</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">instance_variable_set</span>(<span class="ruby-value">:@size</span>, <span class="ruby-number">10</span>)
  <span class="ruby-comment"># take all the connections</span>
  <span class="ruby-identifier">conns</span> = (<span class="ruby-number">1</span><span class="ruby-operator">..</span><span class="ruby-number">10</span>).<span class="ruby-identifier">map</span> { <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> }
  <span class="ruby-identifier">mutex</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">successes</span> = []    <span class="ruby-comment"># threads that successfully got a connection</span>
  <span class="ruby-identifier">errors</span> = []

  <span class="ruby-identifier">make_thread</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">t</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
      <span class="ruby-keyword">begin</span>
        <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> <span class="ruby-comment"># never checked back in</span>
        <span class="ruby-identifier">mutex</span>.<span class="ruby-identifier">synchronize</span> { <span class="ruby-identifier">successes</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">i</span> }
      <span class="ruby-keyword">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
        <span class="ruby-identifier">mutex</span>.<span class="ruby-identifier">synchronize</span> { <span class="ruby-identifier">errors</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">e</span> }
      <span class="ruby-keyword">end</span>
    }
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">pass</span> <span class="ruby-keyword">until</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;sleep&quot;</span>
    <span class="ruby-identifier">t</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># all group1 threads start waiting before any in group2</span>
  <span class="ruby-identifier">group1</span> = (<span class="ruby-number">1</span><span class="ruby-operator">..</span><span class="ruby-number">5</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">make_thread</span>)
  <span class="ruby-identifier">group2</span> = (<span class="ruby-number">6</span><span class="ruby-operator">..</span><span class="ruby-number">10</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">make_thread</span>)

  <span class="ruby-comment"># checkin n connections back to the pool</span>
  <span class="ruby-identifier">checkin</span> = <span class="ruby-identifier">proc</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">n</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">c</span> = <span class="ruby-identifier">conns</span>.<span class="ruby-identifier">pop</span>
      <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkin</span>(<span class="ruby-identifier">c</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">checkin</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">group1</span>.<span class="ruby-identifier">size</span>)         <span class="ruby-comment"># should wake up all group1</span>

  <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">sleep</span> <span class="ruby-number">0.1</span>
    <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">mutex</span>.<span class="ruby-identifier">synchronize</span> { (<span class="ruby-identifier">successes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">size</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">group1</span>.<span class="ruby-identifier">size</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">winners</span> = <span class="ruby-identifier">mutex</span>.<span class="ruby-identifier">synchronize</span> { <span class="ruby-identifier">successes</span>.<span class="ruby-identifier">dup</span> }
  <span class="ruby-identifier">checkin</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">group2</span>.<span class="ruby-identifier">size</span>)         <span class="ruby-comment"># should wake up everyone remaining</span>

  <span class="ruby-identifier">group1</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:join</span>)
  <span class="ruby-identifier">group2</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:join</span>)

  <span class="ruby-identifier">assert_equal</span>((<span class="ruby-number">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">group1</span>.<span class="ruby-identifier">size</span>).<span class="ruby-identifier">to_a</span>, <span class="ruby-identifier">winners</span>.<span class="ruby-identifier">sort</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">any?</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-identifier">errors</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_full_pool_blocks">
            
              <b>test_full_pool_blocks</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_full_pool_blocks" name="method-i-test_full_pool_blocks" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_full_pool_blocks_source')" id="l_method-i-test_full_pool_blocks_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L98" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_full_pool_blocks_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 98</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_full_pool_blocks</span>
  <span class="ruby-identifier">cs</span> = <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>.<span class="ruby-identifier">map</span> { <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> }
  <span class="ruby-identifier">t</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> { <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> }

  <span class="ruby-comment"># make sure our thread is in the timeout section</span>
  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">pass</span> <span class="ruby-keyword">until</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;sleep&quot;</span>

  <span class="ruby-identifier">connection</span> = <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">connection</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">join</span>.<span class="ruby-identifier">value</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_full_pool_exception">
            
              <b>test_full_pool_exception</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_full_pool_exception" name="method-i-test_full_pool_exception" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_full_pool_exception_source')" id="l_method-i-test_full_pool_exception_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L91" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_full_pool_exception_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 91</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_full_pool_exception</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span> { <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> }
  <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">ConnectionTimeoutError</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_pool_sets_connection_visitor">
            
              <b>test_pool_sets_connection_visitor</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_pool_sets_connection_visitor" name="method-i-test_pool_sets_connection_visitor" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_pool_sets_connection_visitor_source')" id="l_method-i-test_pool_sets_connection_visitor_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L330" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_pool_sets_connection_visitor_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 330</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_pool_sets_connection_visitor</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">visitor</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Arel</span><span class="ruby-operator">::</span><span class="ruby-constant">Visitors</span><span class="ruby-operator">::</span><span class="ruby-constant">ToSql</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_reap_and_active">
            
              <b>test_reap_and_active</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_reap_and_active" name="method-i-test_reap_and_active" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_reap_and_active_source')" id="l_method-i-test_reap_and_active_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L123" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_reap_and_active_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 123</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_reap_and_active</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span>

  <span class="ruby-identifier">connections</span> = <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connections</span>.<span class="ruby-identifier">dup</span>

  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">reap</span>

  <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">connections</span>.<span class="ruby-identifier">length</span>, <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connections</span>.<span class="ruby-identifier">length</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_reap_inactive">
            
              <b>test_reap_inactive</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_reap_inactive" name="method-i-test_reap_inactive" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_reap_inactive_source')" id="l_method-i-test_reap_inactive_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L135" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_reap_inactive_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 135</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_reap_inactive</span>
  <span class="ruby-identifier">ready</span> = <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Concurrency</span><span class="ruby-operator">::</span><span class="ruby-constant">Latch</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span>
  <span class="ruby-identifier">child</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span>
    <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span>
    <span class="ruby-identifier">ready</span>.<span class="ruby-identifier">release</span>
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">stop</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">ready</span>.<span class="ruby-identifier">await</span>

  <span class="ruby-identifier">assert_equal</span> <span class="ruby-number">3</span>, <span class="ruby-identifier">active_connections</span>(<span class="ruby-ivar">@pool</span>).<span class="ruby-identifier">size</span>

  <span class="ruby-identifier">child</span>.<span class="ruby-identifier">terminate</span>
  <span class="ruby-identifier">child</span>.<span class="ruby-identifier">join</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">reap</span>

  <span class="ruby-identifier">assert_equal</span> <span class="ruby-number">1</span>, <span class="ruby-identifier">active_connections</span>(<span class="ruby-ivar">@pool</span>).<span class="ruby-identifier">size</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connections</span>.<span class="ruby-identifier">each</span>(<span class="ruby-operator">&amp;</span><span class="ruby-value">:close</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_released_connection_moves_between_threads">
            
              <b>test_released_connection_moves_between_threads</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_released_connection_moves_between_threads" name="method-i-test_released_connection_moves_between_threads" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_released_connection_moves_between_threads_source')" id="l_method-i-test_released_connection_moves_between_threads_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L44" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_released_connection_moves_between_threads_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 44</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_released_connection_moves_between_threads</span>
  <span class="ruby-identifier">thread_conn</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">with_connection</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">thread_conn</span> = <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">end</span>
  }.<span class="ruby-identifier">join</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">thread_conn</span>

  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">with_connection</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">thread_conn</span>, <span class="ruby-identifier">conn</span>
    <span class="ruby-keyword">end</span>
  }.<span class="ruby-identifier">join</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_remove_connection">
            
              <b>test_remove_connection</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_remove_connection" name="method-i-test_remove_connection" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_remove_connection_source')" id="l_method-i-test_remove_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L157" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_remove_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 157</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_remove_connection</span>
  <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span>

  <span class="ruby-identifier">length</span> = <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connections</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">conn</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">in_use?</span>
  <span class="ruby-identifier">assert_equal</span>(<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-number">1</span>, <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connections</span>.<span class="ruby-identifier">length</span>)
<span class="ruby-keyword">ensure</span>
  <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">close</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_remove_connection_for_thread">
            
              <b>test_remove_connection_for_thread</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_remove_connection_for_thread" name="method-i-test_remove_connection_for_thread" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_remove_connection_for_thread_source')" id="l_method-i-test_remove_connection_for_thread_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L169" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_remove_connection_for_thread_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 169</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_remove_connection_for_thread</span>
  <span class="ruby-identifier">conn</span> = <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">conn</span>
  <span class="ruby-identifier">assert_not_equal</span>(<span class="ruby-identifier">conn</span>, <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">connection</span>)
<span class="ruby-keyword">ensure</span>
  <span class="ruby-identifier">conn</span>.<span class="ruby-identifier">close</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">conn</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_removing_releases_latch">
            
              <b>test_removing_releases_latch</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_removing_releases_latch" name="method-i-test_removing_releases_latch" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_removing_releases_latch_source')" id="l_method-i-test_removing_releases_latch_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L110" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_removing_releases_latch_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 110</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_removing_releases_latch</span>
  <span class="ruby-identifier">cs</span> = <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>.<span class="ruby-identifier">map</span> { <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> }
  <span class="ruby-identifier">t</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> { <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">checkout</span> }

  <span class="ruby-comment"># make sure our thread is in the timeout section</span>
  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">pass</span> <span class="ruby-keyword">until</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;sleep&quot;</span>

  <span class="ruby-identifier">connection</span> = <span class="ruby-identifier">cs</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-ivar">@pool</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">assert_respond_to</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">join</span>.<span class="ruby-identifier">value</span>, <span class="ruby-value">:execute</span>
  <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">close</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_with_connection">
            
              <b>test_with_connection</b>()
            
            <a href="../../../classes/ActiveRecord/ConnectionAdapters/ConnectionPoolTest.html#method-i-test_with_connection" name="method-i-test_with_connection" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_with_connection_source')" id="l_method-i-test_with_connection_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/34e54fa0542ebb3403932ab785239119e449dc3c/activerecord/test/cases/connection_pool_test.rb#L62" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_with_connection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/connection_pool_test.rb, line 62</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_with_connection</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-number">0</span>, <span class="ruby-identifier">active_connections</span>(<span class="ruby-identifier">pool</span>).<span class="ruby-identifier">size</span>

  <span class="ruby-identifier">main_thread</span> = <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-number">1</span>, <span class="ruby-identifier">active_connections</span>(<span class="ruby-identifier">pool</span>).<span class="ruby-identifier">size</span>

  <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> {
    <span class="ruby-identifier">pool</span>.<span class="ruby-identifier">with_connection</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">conn</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">assert</span> <span class="ruby-identifier">conn</span>
      <span class="ruby-identifier">assert_equal</span> <span class="ruby-number">2</span>, <span class="ruby-identifier">active_connections</span>(<span class="ruby-identifier">pool</span>).<span class="ruby-identifier">size</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">assert_equal</span> <span class="ruby-number">1</span>, <span class="ruby-identifier">active_connections</span>(<span class="ruby-identifier">pool</span>).<span class="ruby-identifier">size</span>
  }.<span class="ruby-identifier">join</span>

  <span class="ruby-identifier">main_thread</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-number">0</span>, <span class="ruby-identifier">active_connections</span>(<span class="ruby-identifier">pool</span>).<span class="ruby-identifier">size</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    