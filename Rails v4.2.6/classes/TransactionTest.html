<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>TransactionTest</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../css/github.css" type="text/css" media="screen" />
<script src="../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Class</span> 
            TransactionTest 
            
                <span class="parent">&lt; 
                    
                    ActiveRecord::TestCase
                    
                </span>
            
        </h1>
        <ul class="files">
            
            <li><a href="../files/activerecord/test/cases/transactions_test_rb.html">activerecord/test/cases/transactions_test.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-after_create_for_transaction">after_create_for_transaction</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-setup">setup</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>T</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-test_callback_rollback_in_create">test_callback_rollback_in_create</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_callback_rollback_in_create_with_record_invalid_exception">test_callback_rollback_in_create_with_record_invalid_exception</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_cancellation_from_before_destroy_rollbacks_in_destroy">test_cancellation_from_before_destroy_rollbacks_in_destroy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_failing_on_exception">test_failing_on_exception</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_force_savepoint_in_nested_transaction">test_force_savepoint_in_nested_transaction</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_force_savepoint_on_instance">test_force_savepoint_on_instance</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_invalid_keys_for_transaction">test_invalid_keys_for_transaction</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_manually_rolling_back_a_transaction">test_manually_rolling_back_a_transaction</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_many_savepoints">test_many_savepoints</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_nested_explicit_transactions">test_nested_explicit_transactions</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_no_savepoint_in_nested_transaction_without_force">test_no_savepoint_in_nested_transaction_without_force</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_number_of_transactions_in_commit">test_number_of_transactions_in_commit</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_persisted_in_a_model_with_custom_primary_key_after_failed_save">test_persisted_in_a_model_with_custom_primary_key_after_failed_save</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_raise_after_destroy">test_raise_after_destroy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_raising_exception_in_callback_rollbacks_in_save">test_raising_exception_in_callback_rollbacks_in_save</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_raising_exception_in_nested_transaction_restore_state_in_save">test_raising_exception_in_nested_transaction_restore_state_in_save</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_releasing_named_savepoints">test_releasing_named_savepoints</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_restore_active_record_state_for_all_records_in_a_transaction">test_restore_active_record_state_for_all_records_in_a_transaction</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_restore_frozen_state_after_double_destroy">test_restore_frozen_state_after_double_destroy</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_rollback_for_freshly_persisted_records">test_rollback_for_freshly_persisted_records</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_rollback_of_frozen_records">test_rollback_of_frozen_records</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_rollback_when_commit_raises">test_rollback_when_commit_raises</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_rollback_when_saving_a_frozen_record">test_rollback_when_saving_a_frozen_record</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_rollback_when_thread_killed">test_rollback_when_thread_killed</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_rolling_back_in_a_callback_rollbacks_before_save">test_rolling_back_in_a_callback_rollbacks_before_save</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_savepoints_name">test_savepoints_name</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_sqlite_add_column_in_transaction">test_sqlite_add_column_in_transaction</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_successful">test_successful</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_successful_with_instance_method">test_successful_with_instance_method</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_successful_with_return">test_successful_with_return</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_transaction_rollback_with_primarykeyless_tables">test_transaction_rollback_with_primarykeyless_tables</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_transaction_state_is_cleared_when_record_is_persisted">test_transaction_state_is_cleared_when_record_is_persisted</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_transactions_state_from_commit">test_transactions_state_from_commit</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_transactions_state_from_rollback">test_transactions_state_from_rollback</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_update_should_rollback_on_failure">test_update_should_rollback_on_failure</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_update_should_rollback_on_failure-21">test_update_should_rollback_on_failure!</a>,
              </li>
            
              
              <li>
                <a href="#method-i-test_using_named_savepoints">test_using_named_savepoints</a>,
              </li>
            
              
              <li>
                <a href="#method-i-transaction_with_return">transaction_with_return</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
        
      <div class="sectiontitle">Instance Public methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-after_create_for_transaction">
            
              <b>after_create_for_transaction</b>()
            
            <a href="../classes/TransactionTest.html#method-i-after_create_for_transaction" name="method-i-after_create_for_transaction" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-after_create_for_transaction_source')" id="l_method-i-after_create_for_transaction_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L243" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-after_create_for_transaction_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 243</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">after_create_for_transaction</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Make the transaction rollback&#39;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-setup">
            
              <b>setup</b>()
            
            <a href="../classes/TransactionTest.html#method-i-setup" name="method-i-setup" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-setup_source')" id="l_method-i-setup_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L15" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-setup_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 15</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">setup</span>
  <span class="ruby-ivar">@first</span>, <span class="ruby-ivar">@second</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>, <span class="ruby-number">2</span>).<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> }
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_callback_rollback_in_create">
            
              <b>test_callback_rollback_in_create</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_callback_rollback_in_create" name="method-i-test_callback_rollback_in_create" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_callback_rollback_in_create_source')" id="l_method-i-test_callback_rollback_in_create_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L241" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_callback_rollback_in_create_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 241</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_callback_rollback_in_create</span>
  <span class="ruby-identifier">topic</span> = <span class="ruby-constant">Class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Topic</span>) {
    <span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">after_create_for_transaction</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Make the transaction rollback&#39;</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-identifier">new_topic</span> = <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:title</span>                =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;A new topic&quot;</span>,
                        <span class="ruby-value">:author_name</span>          =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Ben&quot;</span>,
                        <span class="ruby-value">:author_email_address</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;ben@example.com&quot;</span>,
                        <span class="ruby-value">:written_on</span>           =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;2003-07-16t15:28:11.2233+01:00&quot;</span>,
                        <span class="ruby-value">:last_read</span>            =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;2004-04-15&quot;</span>,
                        <span class="ruby-value">:bonus_time</span>           =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;2005-01-30t15:28:00.00+01:00&quot;</span>,
                        <span class="ruby-value">:content</span>              =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;Have a nice day&quot;</span>,
                        <span class="ruby-value">:approved</span>             =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">false</span>)

  <span class="ruby-identifier">new_record_snapshot</span> = <span class="ruby-operator">!</span><span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">persisted?</span>
  <span class="ruby-identifier">id_present</span> = <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">has_attribute?</span>(<span class="ruby-constant">Topic</span>.<span class="ruby-identifier">primary_key</span>)
  <span class="ruby-identifier">id_snapshot</span> = <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">id</span>

  <span class="ruby-comment"># Make sure the second save gets the after_create callback called.</span>
  <span class="ruby-number">2</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-identifier">e</span> = <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">RuntimeError</span>) { <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">save</span> }
    <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;Make the transaction rollback&quot;</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
    <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">new_record_snapshot</span>, <span class="ruby-operator">!</span><span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&quot;The topic should have its old persisted value&quot;</span>
    <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">id_snapshot</span>, <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">id</span>, <span class="ruby-string">&quot;The topic should have its old id&quot;</span>
    <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">id_present</span>, <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">has_attribute?</span>(<span class="ruby-constant">Topic</span>.<span class="ruby-identifier">primary_key</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_callback_rollback_in_create_with_record_invalid_exception">
            
              <b>test_callback_rollback_in_create_with_record_invalid_exception</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_callback_rollback_in_create_with_record_invalid_exception" name="method-i-test_callback_rollback_in_create_with_record_invalid_exception" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_callback_rollback_in_create_with_record_invalid_exception_source')" id="l_method-i-test_callback_rollback_in_create_with_record_invalid_exception_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L272" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_callback_rollback_in_create_with_record_invalid_exception_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 272</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_callback_rollback_in_create_with_record_invalid_exception</span>
  <span class="ruby-identifier">topic</span> = <span class="ruby-constant">Class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Topic</span>) {
    <span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">after_create_for_transaction</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordInvalid</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">Author</span>.<span class="ruby-identifier">new</span>)
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-identifier">new_topic</span> = <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">create</span>(<span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;A new topic&quot;</span>)
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&quot;The topic should not be persisted&quot;</span>
  <span class="ruby-identifier">assert_nil</span> <span class="ruby-identifier">new_topic</span>.<span class="ruby-identifier">id</span>, <span class="ruby-string">&quot;The topic should not have an ID&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_cancellation_from_before_destroy_rollbacks_in_destroy">
            
              <b>test_cancellation_from_before_destroy_rollbacks_in_destroy</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_cancellation_from_before_destroy_rollbacks_in_destroy" name="method-i-test_cancellation_from_before_destroy_rollbacks_in_destroy" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_cancellation_from_before_destroy_rollbacks_in_destroy_source')" id="l_method-i-test_cancellation_from_before_destroy_rollbacks_in_destroy_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L204" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_cancellation_from_before_destroy_rollbacks_in_destroy_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 204</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_cancellation_from_before_destroy_rollbacks_in_destroy</span>
  <span class="ruby-identifier">add_cancelling_before_destroy_with_db_side_effect_to_topic</span> <span class="ruby-ivar">@first</span>
  <span class="ruby-identifier">nbooks_before_destroy</span> = <span class="ruby-constant">Book</span>.<span class="ruby-identifier">count</span>
  <span class="ruby-identifier">status</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">destroy</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">status</span>
  <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">nbooks_before_destroy</span>, <span class="ruby-constant">Book</span>.<span class="ruby-identifier">count</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_failing_on_exception">
            
              <b>test_failing_on_exception</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_failing_on_exception" name="method-i-test_failing_on_exception" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_failing_on_exception_source')" id="l_method-i-test_failing_on_exception_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L120" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_failing_on_exception_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 120</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_failing_on_exception</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
      <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
      <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Bad things!&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-comment"># caught it</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First should still be changed in the objects&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should still be changed in the objects&quot;</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First shouldn&#39;t have been approved&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should still be approved&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_force_savepoint_in_nested_transaction">
            
              <b>test_force_savepoint_in_nested_transaction</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_force_savepoint_in_nested_transaction" name="method-i-test_force_savepoint_in_nested_transaction" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_force_savepoint_in_nested_transaction_source')" id="l_method-i-test_force_savepoint_in_nested_transaction_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L322" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_force_savepoint_in_nested_transaction_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 322</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_force_savepoint_in_nested_transaction</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save!</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-value">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span>
        <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">happy</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
        <span class="ruby-identifier">raise</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_force_savepoint_on_instance">
            
              <b>test_force_savepoint_on_instance</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_force_savepoint_on_instance" name="method-i-test_force_savepoint_on_instance" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_force_savepoint_on_instance_source')" id="l_method-i-test_force_savepoint_on_instance_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L343" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_force_savepoint_on_instance_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 343</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_force_savepoint_on_instance</span>
  <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save!</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-value">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span>
        <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">happy</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
        <span class="ruby-identifier">raise</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_invalid_keys_for_transaction">
            
              <b>test_invalid_keys_for_transaction</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_invalid_keys_for_transaction" name="method-i-test_invalid_keys_for_transaction" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_invalid_keys_for_transaction_source')" id="l_method-i-test_invalid_keys_for_transaction_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L315" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_invalid_keys_for_transaction_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 315</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_invalid_keys_for_transaction</span>
  <span class="ruby-identifier">assert_raise</span> <span class="ruby-constant">ArgumentError</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-value">:nested</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_manually_rolling_back_a_transaction">
            
              <b>test_manually_rolling_back_a_transaction</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_manually_rolling_back_a_transaction" name="method-i-test_manually_rolling_back_a_transaction" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_manually_rolling_back_a_transaction_source')" id="l_method-i-test_manually_rolling_back_a_transaction_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L298" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_manually_rolling_back_a_transaction_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 298</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_manually_rolling_back_a_transaction</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>

    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First should still be changed in the objects&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should still be changed in the objects&quot;</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First shouldn&#39;t have been approved&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should still be approved&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_many_savepoints">
            
              <b>test_many_savepoints</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_many_savepoints" name="method-i-test_many_savepoints" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_many_savepoints_source')" id="l_method-i-test_many_savepoints_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L385" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_many_savepoints_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 385</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_many_savepoints</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">content</span> = <span class="ruby-string">&quot;One&quot;</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-value">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span>
        <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">content</span> = <span class="ruby-string">&quot;Two&quot;</span>
        <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>

        <span class="ruby-keyword">begin</span>
          <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-value">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span>
            <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">content</span> = <span class="ruby-string">&quot;Three&quot;</span>
            <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>

            <span class="ruby-keyword">begin</span>
              <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-value">:requires_new</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span>
                <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">content</span> = <span class="ruby-string">&quot;Four&quot;</span>
                <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
                <span class="ruby-identifier">raise</span>
              <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">rescue</span>
            <span class="ruby-keyword">end</span>

            <span class="ruby-ivar">@three</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">content</span>
            <span class="ruby-identifier">raise</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">rescue</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-ivar">@two</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">content</span>
        <span class="ruby-identifier">raise</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-ivar">@one</span> = <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">content</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;One&quot;</span>, <span class="ruby-ivar">@one</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;Two&quot;</span>, <span class="ruby-ivar">@two</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;Three&quot;</span>, <span class="ruby-ivar">@three</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_nested_explicit_transactions">
            
              <b>test_nested_explicit_transactions</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_nested_explicit_transactions" name="method-i-test_nested_explicit_transactions" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_nested_explicit_transactions_source')" id="l_method-i-test_nested_explicit_transactions_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L284" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_nested_explicit_transactions_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 284</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_nested_explicit_transactions</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
      <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
      <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
      <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First should have been approved&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should have been unapproved&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_no_savepoint_in_nested_transaction_without_force">
            
              <b>test_no_savepoint_in_nested_transaction_without_force</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_no_savepoint_in_nested_transaction_without_force" name="method-i-test_no_savepoint_in_nested_transaction_without_force" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_no_savepoint_in_nested_transaction_without_force_source')" id="l_method-i-test_no_savepoint_in_nested_transaction_without_force_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L364" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_no_savepoint_in_nested_transaction_without_force_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 364</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_no_savepoint_in_nested_transaction_without_force</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save!</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
        <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
        <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
        <span class="ruby-identifier">raise</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_number_of_transactions_in_commit">
            
              <b>test_number_of_transactions_in_commit</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_number_of_transactions_in_commit" name="method-i-test_number_of_transactions_in_commit" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_number_of_transactions_in_commit_source')" id="l_method-i-test_number_of_transactions_in_commit_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L84" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_number_of_transactions_in_commit_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 84</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_number_of_transactions_in_commit</span>
  <span class="ruby-identifier">num</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">alias</span> <span class="ruby-value">:real_commit_db_transaction</span> <span class="ruby-operator">:</span><span class="ruby-identifier">commit_db_transaction</span>
    <span class="ruby-identifier">define_method</span>(<span class="ruby-value">:commit_db_transaction</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">num</span> = <span class="ruby-identifier">transaction_manager</span>.<span class="ruby-identifier">open_transactions</span>
      <span class="ruby-identifier">real_commit_db_transaction</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert_equal</span> <span class="ruby-number">0</span>, <span class="ruby-identifier">num</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">remove_method</span> <span class="ruby-value">:commit_db_transaction</span>
    <span class="ruby-keyword">alias</span> <span class="ruby-value">:commit_db_transaction</span> <span class="ruby-operator">:</span><span class="ruby-identifier">real_commit_db_transaction</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_persisted_in_a_model_with_custom_primary_key_after_failed_save">
            
              <b>test_persisted_in_a_model_with_custom_primary_key_after_failed_save</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_persisted_in_a_model_with_custom_primary_key_after_failed_save" name="method-i-test_persisted_in_a_model_with_custom_primary_key_after_failed_save" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_persisted_in_a_model_with_custom_primary_key_after_failed_save_source')" id="l_method-i-test_persisted_in_a_model_with_custom_primary_key_after_failed_save_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L19" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_persisted_in_a_model_with_custom_primary_key_after_failed_save_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 19</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_persisted_in_a_model_with_custom_primary_key_after_failed_save</span>
  <span class="ruby-identifier">movie</span> = <span class="ruby-constant">Movie</span>.<span class="ruby-identifier">create</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">movie</span>.<span class="ruby-identifier">persisted?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_raise_after_destroy">
            
              <b>test_raise_after_destroy</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_raise_after_destroy" name="method-i-test_raise_after_destroy" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_raise_after_destroy_source')" id="l_method-i-test_raise_after_destroy_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L24" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_raise_after_destroy_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 24</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_raise_after_destroy</span>
  <span class="ruby-identifier">assert_not</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">frozen?</span>

  <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">RuntimeError</span>) {
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
      <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">destroy</span>
      <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">frozen?</span>
      <span class="ruby-identifier">raise</span>
    <span class="ruby-keyword">end</span>
  }

  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>
  <span class="ruby-identifier">assert_not</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">frozen?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_raising_exception_in_callback_rollbacks_in_save">
            
              <b>test_raising_exception_in_callback_rollbacks_in_save</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_raising_exception_in_callback_rollbacks_in_save" name="method-i-test_raising_exception_in_callback_rollbacks_in_save" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_raising_exception_in_callback_rollbacks_in_save_source')" id="l_method-i-test_raising_exception_in_callback_rollbacks_in_save_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L140" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_raising_exception_in_callback_rollbacks_in_save_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 140</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_raising_exception_in_callback_rollbacks_in_save</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">@first</span>.<span class="ruby-identifier">after_save_for_transaction</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Make the transaction rollback&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">e</span> = <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">RuntimeError</span>) { <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span> }
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;Make the transaction rollback&quot;</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>).<span class="ruby-identifier">approved?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_raising_exception_in_nested_transaction_restore_state_in_save">
            
              <b>test_raising_exception_in_nested_transaction_restore_state_in_save</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_raising_exception_in_nested_transaction_restore_state_in_save" name="method-i-test_raising_exception_in_nested_transaction_restore_state_in_save" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_raising_exception_in_nested_transaction_restore_state_in_save_source')" id="l_method-i-test_raising_exception_in_nested_transaction_restore_state_in_save_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L164" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_raising_exception_in_nested_transaction_restore_state_in_save_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 164</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_raising_exception_in_nested_transaction_restore_state_in_save</span>
  <span class="ruby-identifier">topic</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">new</span>

  <span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">topic</span>.<span class="ruby-identifier">after_save_for_transaction</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&#39;Make the transaction rollback&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">RuntimeError</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> { <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">save</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">new_record?</span>, <span class="ruby-node">&quot;#{topic.inspect} should be new record&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_releasing_named_savepoints">
            
              <b>test_releasing_named_savepoints</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_releasing_named_savepoints" name="method-i-test_releasing_named_savepoints" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_releasing_named_savepoints_source')" id="l_method-i-test_releasing_named_savepoints_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L447" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_releasing_named_savepoints_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 447</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_releasing_named_savepoints</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">create_savepoint</span>(<span class="ruby-string">&quot;another&quot;</span>)
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">release_savepoint</span>(<span class="ruby-string">&quot;another&quot;</span>)

    <span class="ruby-comment"># The savepoint is now gone and we can&#39;t remove it again.</span>
    <span class="ruby-identifier">assert_raises</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">StatementInvalid</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">release_savepoint</span>(<span class="ruby-string">&quot;another&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_restore_active_record_state_for_all_records_in_a_transaction">
            
              <b>test_restore_active_record_state_for_all_records_in_a_transaction</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_restore_active_record_state_for_all_records_in_a_transaction" name="method-i-test_restore_active_record_state_for_all_records_in_a_transaction" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_restore_active_record_state_for_all_records_in_a_transaction_source')" id="l_method-i-test_restore_active_record_state_for_all_records_in_a_transaction_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L534" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_restore_active_record_state_for_all_records_in_a_transaction_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 534</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_restore_active_record_state_for_all_records_in_a_transaction</span>
  <span class="ruby-identifier">topic_without_callbacks</span> = <span class="ruby-constant">Class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">table_name</span> = <span class="ruby-string">&#39;topics&#39;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">topic_1</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;test_1&#39;</span>)
  <span class="ruby-identifier">topic_2</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;test_2&#39;</span>)
  <span class="ruby-identifier">topic_3</span> = <span class="ruby-identifier">topic_without_callbacks</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;test_3&#39;</span>)

  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic_1</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic_2</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic_3</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">destroy</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic_1</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;persisted&#39;</span>
    <span class="ruby-identifier">assert_not_nil</span> <span class="ruby-identifier">topic_1</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic_2</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;persisted&#39;</span>
    <span class="ruby-identifier">assert_not_nil</span> <span class="ruby-identifier">topic_2</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic_3</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;persisted&#39;</span>
    <span class="ruby-identifier">assert_not_nil</span> <span class="ruby-identifier">topic_3</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;persisted&#39;</span>
    <span class="ruby-identifier">assert_not_nil</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">id</span>
    <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">destroyed?</span>, <span class="ruby-string">&#39;destroyed&#39;</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">topic_1</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;not persisted&#39;</span>
  <span class="ruby-identifier">assert_nil</span> <span class="ruby-identifier">topic_1</span>.<span class="ruby-identifier">id</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">topic_2</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;not persisted&#39;</span>
  <span class="ruby-identifier">assert_nil</span> <span class="ruby-identifier">topic_2</span>.<span class="ruby-identifier">id</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">topic_3</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;not persisted&#39;</span>
  <span class="ruby-identifier">assert_nil</span> <span class="ruby-identifier">topic_3</span>.<span class="ruby-identifier">id</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;persisted&#39;</span>
  <span class="ruby-identifier">assert_not_nil</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">id</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">destroyed?</span>, <span class="ruby-string">&#39;not destroyed&#39;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_restore_frozen_state_after_double_destroy">
            
              <b>test_restore_frozen_state_after_double_destroy</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_restore_frozen_state_after_double_destroy" name="method-i-test_restore_frozen_state_after_double_destroy" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_restore_frozen_state_after_double_destroy_source')" id="l_method-i-test_restore_frozen_state_after_double_destroy_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L572" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_restore_frozen_state_after_double_destroy_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 572</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_restore_frozen_state_after_double_destroy</span>
  <span class="ruby-identifier">topic</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">create</span>
  <span class="ruby-identifier">reply</span> = <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">replies</span>.<span class="ruby-identifier">create</span>

  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-comment"># calls #destroy on reply (since dependent: destroy)</span>
    <span class="ruby-identifier">reply</span>.<span class="ruby-identifier">destroy</span>

    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert_not</span> <span class="ruby-identifier">reply</span>.<span class="ruby-identifier">frozen?</span>
  <span class="ruby-identifier">assert_not</span> <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">frozen?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_rollback_for_freshly_persisted_records">
            
              <b>test_rollback_for_freshly_persisted_records</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_rollback_for_freshly_persisted_records" name="method-i-test_rollback_for_freshly_persisted_records" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_rollback_for_freshly_persisted_records_source')" id="l_method-i-test_rollback_for_freshly_persisted_records_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L596" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_rollback_for_freshly_persisted_records_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 596</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_rollback_for_freshly_persisted_records</span>
  <span class="ruby-identifier">topic</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">create</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">destroy</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;persisted&#39;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_rollback_of_frozen_records">
            
              <b>test_rollback_of_frozen_records</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_rollback_of_frozen_records" name="method-i-test_rollback_of_frozen_records" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_rollback_of_frozen_records_source')" id="l_method-i-test_rollback_of_frozen_records_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L587" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_rollback_of_frozen_records_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 587</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_rollback_of_frozen_records</span>
  <span class="ruby-identifier">topic</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">create</span>.<span class="ruby-identifier">freeze</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">destroy</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">frozen?</span>, <span class="ruby-string">&#39;frozen&#39;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_rollback_when_commit_raises">
            
              <b>test_rollback_when_commit_raises</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_rollback_when_commit_raises" name="method-i-test_rollback_when_commit_raises" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_rollback_when_commit_raises_source')" id="l_method-i-test_rollback_when_commit_raises_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L479" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_rollback_when_commit_raises_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 479</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_rollback_when_commit_raises</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-value">:begin_db_transaction</span>)
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-value">:commit_db_transaction</span>).<span class="ruby-identifier">raises</span>(<span class="ruby-string">&#39;OH NOES&#39;</span>)
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">expects</span>(<span class="ruby-value">:rollback_db_transaction</span>)

  <span class="ruby-identifier">assert_raise</span> <span class="ruby-constant">RuntimeError</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
      <span class="ruby-comment"># do nothing</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_rollback_when_saving_a_frozen_record">
            
              <b>test_rollback_when_saving_a_frozen_record</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_rollback_when_saving_a_frozen_record" name="method-i-test_rollback_when_saving_a_frozen_record" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_rollback_when_saving_a_frozen_record_source')" id="l_method-i-test_rollback_when_saving_a_frozen_record_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L491" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_rollback_when_saving_a_frozen_record_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 491</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_rollback_when_saving_a_frozen_record</span>
  <span class="ruby-identifier">topic</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:title</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&#39;test&#39;</span>)
  <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">freeze</span>
  <span class="ruby-identifier">e</span> = <span class="ruby-identifier">assert_raise</span>(<span class="ruby-constant">RuntimeError</span>) { <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">save</span> }
  <span class="ruby-identifier">assert_match</span>(<span class="ruby-regexp">/frozen/i</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>) <span class="ruby-comment"># Not good enough, but we can&#39;t do much</span>
                                     <span class="ruby-comment"># about it since there is no specific error</span>
                                     <span class="ruby-comment"># for frozen objects.</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">topic</span>.<span class="ruby-identifier">persisted?</span>, <span class="ruby-string">&#39;not persisted&#39;</span>
  <span class="ruby-identifier">assert_nil</span> <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">id</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">topic</span>.<span class="ruby-identifier">frozen?</span>, <span class="ruby-string">&#39;not frozen&#39;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_rollback_when_thread_killed">
            
              <b>test_rollback_when_thread_killed</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_rollback_when_thread_killed" name="method-i-test_rollback_when_thread_killed" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_rollback_when_thread_killed_source')" id="l_method-i-test_rollback_when_thread_killed_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L507" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_rollback_when_thread_killed_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 507</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_rollback_when_thread_killed</span>
  <span class="ruby-identifier">queue</span> = <span class="ruby-constant">Queue</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">thread</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
      <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
      <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>

      <span class="ruby-identifier">queue</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">nil</span>
      <span class="ruby-identifier">sleep</span>

      <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">queue</span>.<span class="ruby-identifier">pop</span>
  <span class="ruby-identifier">thread</span>.<span class="ruby-identifier">kill</span>
  <span class="ruby-identifier">thread</span>.<span class="ruby-identifier">join</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First should still be changed in the objects&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should still be changed in the objects&quot;</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First shouldn&#39;t have been approved&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should still be approved&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_rolling_back_in_a_callback_rollbacks_before_save">
            
              <b>test_rolling_back_in_a_callback_rollbacks_before_save</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_rolling_back_in_a_callback_rollbacks_before_save" name="method-i-test_rolling_back_in_a_callback_rollbacks_before_save" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_rolling_back_in_a_callback_rollbacks_before_save_source')" id="l_method-i-test_rolling_back_in_a_callback_rollbacks_before_save_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L151" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_rolling_back_in_a_callback_rollbacks_before_save_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 151</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_rolling_back_in_a_callback_rollbacks_before_save</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">@first</span>.<span class="ruby-identifier">before_save_for_transaction</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>

  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@first</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Should not commit the approved flag&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_savepoints_name">
            
              <b>test_savepoints_name</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_savepoints_name" name="method-i-test_savepoints_name" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_savepoints_name_source')" id="l_method-i-test_savepoints_name_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L459" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_savepoints_name_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 459</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_savepoints_name</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">assert_nil</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_savepoint_name</span>
    <span class="ruby-identifier">assert_nil</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_transaction</span>.<span class="ruby-identifier">savepoint_name</span>

    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-identifier">requires_new</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;active_record_1&quot;</span>, <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_savepoint_name</span>
      <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;active_record_1&quot;</span>, <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_transaction</span>.<span class="ruby-identifier">savepoint_name</span>

      <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span>(<span class="ruby-identifier">requires_new</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;active_record_2&quot;</span>, <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_savepoint_name</span>
        <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;active_record_2&quot;</span>, <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_transaction</span>.<span class="ruby-identifier">savepoint_name</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;active_record_1&quot;</span>, <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_savepoint_name</span>
      <span class="ruby-identifier">assert_equal</span> <span class="ruby-string">&quot;active_record_1&quot;</span>, <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">current_transaction</span>.<span class="ruby-identifier">savepoint_name</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_sqlite_add_column_in_transaction">
            
              <b>test_sqlite_add_column_in_transaction</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_sqlite_add_column_in_transaction" name="method-i-test_sqlite_add_column_in_transaction" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_sqlite_add_column_in_transaction_source')" id="l_method-i-test_sqlite_add_column_in_transaction_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L605" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_sqlite_add_column_in_transaction_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 605</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_sqlite_add_column_in_transaction</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">current_adapter?</span>(<span class="ruby-value">:SQLite3Adapter</span>)

  <span class="ruby-comment"># Test first if column creation/deletion works correctly when no</span>
  <span class="ruby-comment"># transaction is in place.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># We go back to the connection for the column queries because</span>
  <span class="ruby-comment"># Topic.columns is cached and won&#39;t report changes to the DB</span>

  <span class="ruby-identifier">assert_nothing_raised</span> <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">reset_column_information</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">add_column</span>(<span class="ruby-string">&#39;topics&#39;</span>, <span class="ruby-string">&#39;stuff&#39;</span>, <span class="ruby-value">:string</span>)
    <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&#39;stuff&#39;</span>)

    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">reset_column_information</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">remove_column</span>(<span class="ruby-string">&#39;topics&#39;</span>, <span class="ruby-string">&#39;stuff&#39;</span>)
    <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">column_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&#39;stuff&#39;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">supports_ddl_transactions?</span>
    <span class="ruby-identifier">assert_nothing_raised</span> <span class="ruby-keyword">do</span>
      <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> { <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">add_column</span>(<span class="ruby-string">&#39;topics&#39;</span>, <span class="ruby-string">&#39;stuff&#39;</span>, <span class="ruby-value">:string</span>) }
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">assert_raise</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">StatementInvalid</span>) { <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">add_column</span>(<span class="ruby-string">&#39;topics&#39;</span>, <span class="ruby-string">&#39;stuff&#39;</span>, <span class="ruby-value">:string</span>) }
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">remove_column</span>(<span class="ruby-string">&#39;topics&#39;</span>, <span class="ruby-string">&#39;stuff&#39;</span>)
  <span class="ruby-keyword">rescue</span>
  <span class="ruby-keyword">ensure</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">reset_column_information</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_successful">
            
              <b>test_successful</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_successful" name="method-i-test_successful" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_successful_source')" id="l_method-i-test_successful_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L39" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_successful_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 39</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_successful</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First should have been approved&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should have been unapproved&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_successful_with_instance_method">
            
              <b>test_successful_with_instance_method</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_successful_with_instance_method" name="method-i-test_successful_with_instance_method" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_successful_with_instance_method_source')" id="l_method-i-test_successful_with_instance_method_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L108" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_successful_with_instance_method_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 108</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_successful_with_instance_method</span>
  <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First should have been approved&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should have been unapproved&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_successful_with_return">
            
              <b>test_successful_with_return</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_successful_with_return" name="method-i-test_successful_with_return" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_successful_with_return_source')" id="l_method-i-test_successful_with_return_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L61" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_successful_with_return_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 61</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_successful_with_return</span>
  <span class="ruby-identifier">committed</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">alias</span> <span class="ruby-value">:real_commit_db_transaction</span> <span class="ruby-operator">:</span><span class="ruby-identifier">commit_db_transaction</span>
    <span class="ruby-identifier">define_method</span>(<span class="ruby-value">:commit_db_transaction</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">committed</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">real_commit_db_transaction</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">transaction_with_return</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">committed</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;First should have been approved&quot;</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-constant">Topic</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">2</span>).<span class="ruby-identifier">approved?</span>, <span class="ruby-string">&quot;Second should have been unapproved&quot;</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">class_eval</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">remove_method</span> <span class="ruby-value">:commit_db_transaction</span>
    <span class="ruby-keyword">alias</span> <span class="ruby-value">:commit_db_transaction</span> <span class="ruby-operator">:</span><span class="ruby-identifier">real_commit_db_transaction</span> <span class="ruby-keyword">rescue</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_transaction_rollback_with_primarykeyless_tables">
            
              <b>test_transaction_rollback_with_primarykeyless_tables</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_transaction_rollback_with_primarykeyless_tables" name="method-i-test_transaction_rollback_with_primarykeyless_tables" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_transaction_rollback_with_primarykeyless_tables_source')" id="l_method-i-test_transaction_rollback_with_primarykeyless_tables_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L671" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_transaction_rollback_with_primarykeyless_tables_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 671</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_transaction_rollback_with_primarykeyless_tables</span>
  <span class="ruby-identifier">connection</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">create_table</span>(<span class="ruby-value">:transaction_without_primary_keys</span>, <span class="ruby-identifier">force</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>, <span class="ruby-identifier">id</span><span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
     <span class="ruby-identifier">t</span>.<span class="ruby-identifier">integer</span> <span class="ruby-value">:thing_id</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">klass</span> = <span class="ruby-constant">Class</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">table_name</span> = <span class="ruby-string">&#39;transaction_without_primary_keys&#39;</span>
    <span class="ruby-identifier">after_commit</span> { } <span class="ruby-comment"># necessary to trigger the has_transactional_callbacks branch</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">assert_no_difference</span>(<span class="ruby-operator">-</span><span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">count</span> }) <span class="ruby-keyword">do</span>
    <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">create!</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Rollback</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">ensure</span>
  <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">drop_table</span>(<span class="ruby-string">&quot;transaction_without_primary_keys&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">table_exists?</span> <span class="ruby-string">&quot;transaction_without_primary_keys&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_transaction_state_is_cleared_when_record_is_persisted">
            
              <b>test_transaction_state_is_cleared_when_record_is_persisted</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_transaction_state_is_cleared_when_record_is_persisted" name="method-i-test_transaction_state_is_cleared_when_record_is_persisted" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_transaction_state_is_cleared_when_record_is_persisted_source')" id="l_method-i-test_transaction_state_is_cleared_when_record_is_persisted_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L178" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_transaction_state_is_cleared_when_record_is_persisted_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 178</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_transaction_state_is_cleared_when_record_is_persisted</span>
  <span class="ruby-identifier">author</span> = <span class="ruby-constant">Author</span>.<span class="ruby-identifier">create!</span> <span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-string">&#39;foo&#39;</span>
  <span class="ruby-identifier">author</span>.<span class="ruby-identifier">name</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">assert_not</span> <span class="ruby-identifier">author</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-identifier">assert_not</span> <span class="ruby-identifier">author</span>.<span class="ruby-identifier">new_record?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_transactions_state_from_commit">
            
              <b>test_transactions_state_from_commit</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_transactions_state_from_commit" name="method-i-test_transactions_state_from_commit" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_transactions_state_from_commit_source')" id="l_method-i-test_transactions_state_from_commit_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L657" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_transactions_state_from_commit_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 657</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_transactions_state_from_commit</span>
  <span class="ruby-identifier">connection</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">transaction</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionAdapters</span><span class="ruby-operator">::</span><span class="ruby-constant">TransactionManager</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">connection</span>).<span class="ruby-identifier">begin_transaction</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">open?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">rolledback?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">committed?</span>

  <span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">commit</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">rolledback?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">committed?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_transactions_state_from_rollback">
            
              <b>test_transactions_state_from_rollback</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_transactions_state_from_rollback" name="method-i-test_transactions_state_from_rollback" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_transactions_state_from_rollback_source')" id="l_method-i-test_transactions_state_from_rollback_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L643" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_transactions_state_from_rollback_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 643</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_transactions_state_from_rollback</span>
  <span class="ruby-identifier">connection</span> = <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>
  <span class="ruby-identifier">transaction</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectionAdapters</span><span class="ruby-operator">::</span><span class="ruby-constant">TransactionManager</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">connection</span>).<span class="ruby-identifier">begin_transaction</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">open?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">rolledback?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">committed?</span>

  <span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">rollback</span>

  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">rolledback?</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">transaction</span>.<span class="ruby-identifier">state</span>.<span class="ruby-identifier">committed?</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_update_should_rollback_on_failure">
            
              <b>test_update_should_rollback_on_failure</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_update_should_rollback_on_failure" name="method-i-test_update_should_rollback_on_failure" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_update_should_rollback_on_failure_source')" id="l_method-i-test_update_should_rollback_on_failure_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L185" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_update_should_rollback_on_failure_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_update_should_rollback_on_failure</span>
  <span class="ruby-identifier">author</span> = <span class="ruby-constant">Author</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>)
  <span class="ruby-identifier">posts_count</span> = <span class="ruby-identifier">author</span>.<span class="ruby-identifier">posts</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">posts_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-number">0</span>
  <span class="ruby-identifier">status</span> = <span class="ruby-identifier">author</span>.<span class="ruby-identifier">update</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">post_ids</span><span class="ruby-operator">:</span> [])
  <span class="ruby-identifier">assert</span> <span class="ruby-operator">!</span><span class="ruby-identifier">status</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">posts_count</span>, <span class="ruby-identifier">author</span>.<span class="ruby-identifier">posts</span>(<span class="ruby-keyword">true</span>).<span class="ruby-identifier">size</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_update_should_rollback_on_failure-21">
            
              <b>test_update_should_rollback_on_failure!</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_update_should_rollback_on_failure-21" name="method-i-test_update_should_rollback_on_failure-21" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_update_should_rollback_on_failure-21_source')" id="l_method-i-test_update_should_rollback_on_failure-21_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L194" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_update_should_rollback_on_failure-21_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 194</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_update_should_rollback_on_failure!</span>
  <span class="ruby-identifier">author</span> = <span class="ruby-constant">Author</span>.<span class="ruby-identifier">find</span>(<span class="ruby-number">1</span>)
  <span class="ruby-identifier">posts_count</span> = <span class="ruby-identifier">author</span>.<span class="ruby-identifier">posts</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-identifier">assert</span> <span class="ruby-identifier">posts_count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-number">0</span>
  <span class="ruby-identifier">assert_raise</span>(<span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordInvalid</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">author</span>.<span class="ruby-identifier">update!</span>(<span class="ruby-identifier">name</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">post_ids</span><span class="ruby-operator">:</span> [])
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">assert_equal</span> <span class="ruby-identifier">posts_count</span>, <span class="ruby-identifier">author</span>.<span class="ruby-identifier">posts</span>(<span class="ruby-keyword">true</span>).<span class="ruby-identifier">size</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-test_using_named_savepoints">
            
              <b>test_using_named_savepoints</b>()
            
            <a href="../classes/TransactionTest.html#method-i-test_using_named_savepoints" name="method-i-test_using_named_savepoints" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-test_using_named_savepoints_source')" id="l_method-i-test_using_named_savepoints_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L429" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-test_using_named_savepoints_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 429</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">test_using_named_savepoints</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">create_savepoint</span>(<span class="ruby-string">&quot;first&quot;</span>)

    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">rollback_to_savepoint</span>(<span class="ruby-string">&quot;first&quot;</span>)
    <span class="ruby-identifier">assert</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>

    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save!</span>
    <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">release_savepoint</span>(<span class="ruby-string">&quot;first&quot;</span>)
    <span class="ruby-identifier">assert_not</span> <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">reload</span>.<span class="ruby-identifier">approved?</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-transaction_with_return">
            
              <b>transaction_with_return</b>()
            
            <a href="../classes/TransactionTest.html#method-i-transaction_with_return" name="method-i-transaction_with_return" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-transaction_with_return_source')" id="l_method-i-transaction_with_return_source">show</a>
                
                  | <a href="https://github.com/rails/rails/blob/4e115bfab7592843f431ff605e93df47ba2a6270/activerecord/test/cases/transactions_test.rb#L51" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-transaction_with_return_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/test/cases/transactions_test.rb, line 51</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">transaction_with_return</span>
  <span class="ruby-constant">Topic</span>.<span class="ruby-identifier">transaction</span> <span class="ruby-keyword">do</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">approved</span>  = <span class="ruby-keyword">true</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">approved</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-ivar">@first</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-ivar">@second</span>.<span class="ruby-identifier">save</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    